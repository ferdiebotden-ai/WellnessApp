Here is the comprehensive synthesis rewrite of the master blueprint, upgraded to V3.2.

---

# **Master Blueprint: Wellness OS (V3.2)**

**spec\_version:** 3.2 (Conversational Architecture Edition)

**synthesis\_date:** 2025-10-24

**architect\_agent:** Gemini 2.5 Pro (Chief AI Product Architect)

**purpose:** This document is the canonical source of truth for the Wellness OS platform, architected to power an AI orchestration pipeline (Blueprint → Gemini Mission Architect → Codex → Production Code). It synthesizes V3.1 and incorporates V3.2 enhancements for conversational AI, advanced RAG, HIPAA compliance, and updated monetization.

### **Changelog (V3.2 Synthesis)**

* **Conversational AI Pipeline:** Upgraded the "Adaptive Coach" (MISSION\_006) from a one-way nudge engine to a full, two-way **Conversational AI Coach (MISSION\_030)**. This includes a new POST /api/chat endpoint, a 5-step prompt chain (Intent → Context → Evidence → Personalization → Safety), and a new Firestore schema for chat memory.  
* **Security & Compliance:** Integrated a robust, **HIPAA-compliant architecture** for the chat feature. This mandates an **OpenAI BAA** (zero-retention tier), a **PHI De-identification Layer**, and a **7-Layer Ethical Safeguard System** (Crisis Detection, Medical Disclaimers, Citation Verification, etc.).  
* **UX Integration:** Embedded conversational UX patterns from Whoop and Headspace, including a top-bar **AI Coach quick-access button**, contextual chat entry points, and a UI spec for chat bubbles, **Context Cards**, and **Citation Cards**.  
* **Monetization Update:** Updated the pricing tiers (Sec 6.0) to reflect the new chat feature: **Tier 1 ($29/mo)** includes *limited chat* (10 queries/week), and **Tier 2 ($59/mo)** unlocks *unlimited chat* as a primary upsell driver.  
* **Strategic Roadmap:** Re-affirmed the Conversational AI Coach as a **Phase 2 feature (MISSION\_030)**, ensuring the MVP (Phase 1\) remains focused on validating the core adherence loop *before* introducing chat complexity.

---

## **1.0 Executive Summary**

* **Vision:** "Evidence made effortless."  
* **Mission:** To transform peer-reviewed health protocols into sustainable daily habits for performance professionals, optimizing sleep, energy, focus, and resilience through AI-powered personalization.  
* **Target Persona:** Performance Professionals (Founders, Executives, Knowledge Workers, age 25-40), "Huberman Lab" listeners, existing wearable owners, evidence-obsessed, and time-starved.  
* **North Star Metric:** ≥6 days/week protocol adherence by Day 30 (Target: 40% of users).  
* **Core Differentiators:** (1) **Module-Centric UX** (focus on life-area improvement), (2) **Evidence UX** (DOI citations for all protocols), (3) **Conversational AI Coach (GPT-5, RAG-powered, HIPAA-compliant)**, (4) **Multi-Wearable BYOD** (starting with aggregators), (5) **Protocol Engine with Evidence-Based Engagement** (health outcomes, not game mechanics).  
* **Monetization Model:** 14-day free trial (no CC required), then subscription. Tiers: **Tier 1 (Core @ $29/mo, limited chat)**, **Tier 2 (Pro @ $59/mo, unlimited chat)**, **Tier 3 (Elite @ $99/mo)**.  
* **MVP Strategy:** Launch with Tier 1 (Core) on a 14-day trial, including the *proactive nudge engine* and *limited chat*. Implement a **waitlist** to build demand for Tier 2 (unlimited chat) and Tier 3\.

### **1.1 Architectural Decisions (Architect's Rationale)**

This blueprint is architected for MVP speed, scalability, and AI-readiness, based on analysis of all provided drafts and mandatory changes.

1. **ADR-001: 3-Database Hybrid Strategy**  
   * **Decision:** We will adopt a 3-database model, rejecting the 4-DB model's client-side SQLite complexity for the MVP.  
   * **Supabase (PostgreSQL):** The relational *source of truth* for persistent, analytical data (users, protocols, modules, protocol\_logs, ai\_audit\_logs, wearable\_data\_archive).  
   * **Firestore (NoSQL):** The *real-time state & sync* layer. Used for ephemeral data, real-time UI updates, conversational memory, and its excellent offline-first mobile SDK. (user\_schedules, live\_nudges, chat\_conversations).  
   * **Pinecone (Vector):** The *RAG & semantic search* layer. Managed, serverless, and fast for protocol embeddings.  
   * **Rationale:** This stack provides the persistence of SQL, the real-time speed of NoSQL, and the AI-readiness of a vector DB, while maximizing managed services to reduce MVP operational overhead.  
2. **ADR-002: Serverless API & Auth**  
   * **Decision:** The backend will be serverless **Google Cloud Functions (GCF)** (running Node.js/TypeScript) fronted by an API Gateway, not a monolithic server.  
   * **Authentication:** **Firebase Auth** will be the primary identity provider (best-in-class mobile SDKs). The Firebase JWT will be passed to GCFs and used to authenticate against Supabase RLS policies.  
   * **Rationale:** This is the most scalable, cost-effective, and secure model for an event-driven MVP. It leverages Firebase's auth strength with Supabase's RLS data security.  
3. **ADR-003: Module-First Architecture**  
   * **Decision:** The entire architecture is refactored around the **Module Framework**. This is a non-negotiable user-facing abstraction.  
   * **Implementation:** The data model *must* include modules (Life Domains), protocols (reusable actions), and a mapping table. Onboarding, analytics, nudges, and paywalls *must* be module-aware.  
   * **Rationale:** This aligns the product with the user's mental model ("I want to improve my sleep") and creates a "bolt-on" architecture, allowing us to add new modules in future phases without re-architecting the core.  
4. **ADR-004: Mandatory Change Integration (V3.2 Update)**  
   * **AI:** All AI-driven missions (MISSION\_006, MISSION\_030) will spec **GPT-5** with a professional, evidence-based prompt. The architecture is now defined for a two-way, RAG-powered, HIPAA-compliant conversational service.  
   * **Pricing:** All monetization sections (6.0) are updated for the **14-day trial** and **$29 (limited chat) / $59 (unlimited chat) / $99** price points.  
   * **Engagement:** All engagement missions (MISSION\_017, MISSION\_019) are updated to reflect the "Evidence-Based Retention" model (streaks with forgiveness, health outcome tracking, 4 milestone badges), *not* gamification.  
   * **Wearables:** MISSION\_014 and MISSION\_015 are *strictly* scoped to **Apple Health & Google Fit** for MVP.  
   * **Compliance:** The architecture *must* implement the **7-Layer Ethical Safeguard System** and **PHI De-identification** (Sec 7.0) as a prerequisite for the chat feature.

---

## **2.0 System Architecture**

### **2.1 Technical Stack**

* **Cloud Platform:** Google Cloud Platform (GCP)  
* **Backend:** Serverless via Google Cloud Functions (Node.js v20+, TypeScript)  
* **API:** GCP API Gateway (RESTful)  
* **Database (Relational):** Supabase (PostgreSQL 15+) \- *Source of Truth*  
* **Database (Real-time/Sync):** Firestore \- *State, Offline Sync, Chat Memory*  
* **Database (Vector):** Pinecone (Serverless) \- *RAG & Semantic Search*  
* **Authentication:** Firebase Authentication (Identity Provider)  
* **AI (LLM):** OpenAI API (Model: gpt-5-turbo or equivalent, **Zero-Retention Tier**)  
* **AI (Embeddings):** OpenAI API (text-embedding-3-large)  
* **AI Orchestration:** LangChain (TypeScript)  
* **Mobile Client:** React Native (with Expo managed workflow)  
* **File Storage:** Firebase Storage (GCS)  
* **Analytics:** Mixpanel (MVP), migrating to BigQuery (Phase 2\)  
* **CI/CD:** GitHub Actions  
* **Feature Flags:** LaunchDarkly (or Firebase Remote Config)  
* **Error Tracking:** Sentry

### **2.2 Data Model (High-Level Schemas)**

*(Defined in TypeScript for clarity and AI parsing. Stored in Supabase unless noted.)*

TypeScript

// \--- Core Relational Tables (Supabase) \---

interface User {  
id: string; // UUID, mirrors Firebase Auth UID  
email: string; // Unique  
display\_name?: string;  
tier: 'trial' | 'core' | 'pro' | 'elite' | 'lapsed';  
trial\_start\_date: Date;  
trial\_end\_date: Date;  
subscription\_id?: string; // Stripe/RevenueCat ID  
onboarding\_complete: boolean;  
preferences: UserPreferences; // JSONB  
created\_at: Date;  
// V3.1 Enhancement: Health Outcome Tracking  
healthMetrics: { // JSONB  
sleepQualityTrend: number  
; // 7-day moving average  
hrvImprovementPct: number; // vs baseline  
protocolAdherencePct: number; // 30-day  
moduleProgressPct: {  
$$moduleId: string$$  
: number };  
};  
earnedBadges: string  
; // e.g.,

$$'foundation\\\_builder', 'protocol\\\_practitioner'$$

}  
interface UserPreferences { // Stored in User.preferences JSONB  
primary\_module\_id?: string;  
nudge\_tone: 'motivational' | 'neutral' | 'minimal';  
quiet\_hours\_enabled: boolean;  
quiet\_start\_time: string; // HH:MM local  
quiet\_end\_time: string; // HH:MM local  
social\_anonymous: boolean; // MANDATORY: For anonymous leaderboards (Phase 2\)  
}  
interface Module { // The 6 "Life Domains"  
id: string; // e.g., 'mod\_sleep'  
name: string; // e.g., 'Sleep Optimization'  
description: string;  
icon\_svg: string;  
// V3.1 Enhancement  
outcomeMetric: string; // e.g., "Sleep Quality Score"  
starterProtocols: string  
; // Array of protocol\_ids  
tier: 'core' | 'pro' | 'elite'; // Which tier unlocks this module  
}  
interface Protocol { // The 18 reusable "Actions"  
id: string; // e.g., 'proto\_morning\_light'  
name: string; // e.g., 'Morning Light Exposure'  
category: 'Foundation' | 'Performance' | 'Recovery' | 'Optimization' | 'Meta';  
// ... other details from Protocol Libraries  
}  
interface ModuleProtocolMap { // Many-to-Many mapping  
id: string; // UUID  
module\_id: string; // Foreign Key to Module.id  
protocol\_id: string; // Foreign Key to Protocol.id  
is\_starter\_protocol: boolean; // Is this a default protocol for this module?  
tier\_required: 'core' | 'pro' | 'elite'; // Tier to unlock this specific protocol  
}  
interface ModuleEnrollment { // User's active modules  
id: string; // UUID  
user\_id: string; // Foreign Key to User.id  
module\_id: string; // Foreign Key to Module.id  
is\_primary: boolean;  
enrolled\_at: Date;  
// V3.1 Enhancement: Module-level streaks & progress  
currentStreak: number;  
longestStreak: number;  
lastActiveDate: Date;  
progressPct: number; // Protocols completed / total  
streakFreezeAvailable: boolean; // 1 per week  
streakFreezeUsedDate?: Date;  
}  
interface ProtocolLog { // User's adherence log  
id: string; // UUID  
user\_id: string;  
protocol\_id: string;  
module\_id: string; // Which module cued this action?  
date: Date; // ISO 8601 Date  
status: 'completed' | 'skipped' | 'partial';  
source: 'nudge' | 'manual' | 'schedule';  
created\_at: Date;  
}  
interface WearableDataArchive { // Historical data archive  
id: string; // UUID  
user\_id: string;  
source: 'apple\_health' | 'google\_fit' | 'oura' | 'whoop';  
date: Date;  
metric\_type: 'hrv' | 'rhr' | 'sleep\_hours' | 'steps';  
value: number;  
unit: string;  
synced\_at: Date;  
}  
interface AIAuditLog { // Log of all AI decisions & feedback  
id: string; // UUID  
user\_id: string;  
timestamp: Date;  
decision\_type: 'nudge\_generated' | 'chat\_response';  
model\_used: 'gpt-5-turbo' | 'rule\_based\_fallback';  
prompt: string;  
response: string; // The generated nudge text or chat response  
reasoning: string; // AI's explanation  
citations: string  
; // DOIs  
module\_id?: string;  
user\_feedback: 'thumb\_up' | 'thumb\_down' | 'none'; // MANDATORY: Simple feedback  
user\_feedback\_text?: string; // Optional text  
// V3.2: Chat-specific audit fields  
conversation\_id?: string; // UUID  
intent\_detected?: string;  
context\_sources?: string  
; // e.g.,

$$'healthMetrics:2025-10-24', 'protocols:sleep-opt'$$

response\_tokens?: number;  
latency\_ms?: number;  
phi\_redacted?: boolean;  
safety\_flags?: string  
; // e.g.,

$$'medical\\\_disclaimer\\\_added', 'crisis\\\_detected'$$

}  
interface WaitlistEntry { // For Tier 2/3 Waitlist  
id: string; // UUID  
email: string; // Unique  
tier\_interested\_in: 'pro' | 'elite';  
created\_at: Date;  
}  
// \--- Real-time State (Firestore) \---

// Path: /schedules/{user\_id}/{YYYY-MM-DD}  
interface DailySchedule {  
protocols: Array\<{  
protocol\_id: string;  
module\_id: string;  
scheduled\_time\_utc: string; // ISO 8601  
duration\_minutes: number;  
status: 'pending' | 'completed' | 'skipped';  
}\>;  
}  
// Path: /live\_nudges/{user\_id}/  
interface LiveNudgeQueue {

$$nudge\\\_id: string$$  
: {  
nudge\_text: string;  
protocol\_id: string;  
module\_id: string;  
reasoning: string;  
citations: string  
; // DOIs  
created\_at: string; // ISO 8601  
};  
}  
// V3.2: Chat Conversation Memory  
// Path: /users/{userId}/conversations/{conversationId}/messages/{messageId}  
interface ChatMessage {  
role: 'user' | 'assistant';  
content: string;  
timestamp: Date; // Firestore Timestamp  
context\_sources?: string  
; // DOIs or internal data sources  
tokens?: {  
input: number;  
output: number;  
};  
}  
// V3.2: PHI Pseudonymization Map  
// Path: /phi\_mappings/{userId}  
interface PhiMapping {  
// Secure collection for mapping real PHI to pseudonyms for AI prompts  
// e.g., "User  
$$uid:a7b9c3$$  
" \-\> "John Doe"  
// Specific schema TBD by security audit, but will house mappings.  
}

### **2.3 Service Boundaries & Communication**

* **Mobile Client (React Native):**  
  * Authenticates using **Firebase Auth SDK**.  
  * Reads/writes to **Firestore** for real-time state (schedules, nudges, chat\_conversations) and offline sync.  
  * Reads device data from **Apple Health / Google Fit**.  
  * Calls **API Gateway (GCFs)** via HTTPS (RESTful) for all persistent actions (logging, profile updates, payments, chat), passing the Firebase JWT for auth.  
* **API Gateway (Google Cloud Functions):**  
  * All functions are auth-protected, validating the Firebase JWT.  
  * Uses the validated JWT to interact with **Supabase (Postgres)**, leveraging RLS.  
  * Handles all business logic: logProtocol, updateProfile, startTrial, joinWaitlist, getModuleProtocols, etc.  
  * **V3.2: POST /api/chat**: New endpoint that orchestrates the 5-step conversational AI chain (MISSION\_030).  
  * Calls external APIs (OpenAI Zero-Retention, Pinecone, Stripe, RevenueCat).  
* **Async Cloud Functions (Event-Driven):**  
  * **NightlyBatch (Pub/Sub):** generateDailySchedules (writes to Firestore), calculateStreaks, runLapseDetection.  
  * **NudgeEngine (Pub/Sub):** generateAdaptiveNudges (uses GPT-5, writes to Firestore live\_nudges and Supabase ai\_audit\_log).  
  * **DataSync (HTTPS):** syncWearableData (called by client, writes to wearable\_data\_archive).  
* **Databases:**  
  * **Supabase (Postgres):** Accessed *only* by backend GCFs. RLS policy: (auth.uid() \= user\_id).  
  * **Firestore:** Accessed by client (read/write) and backend (write-only for schedules/nudges/chat). Firestore Security Rules enforce client permissions (e.g., user can only write to their own /conversations/ subcollection).  
  * **Pinecone:** Accessed *only* by backend GCFs (NudgeEngine, Chat API).

### **2.4 Key Concepts Implementation Strategy**

* **Protocol RAG (Retrieval-Augmented Generation):**  
  * **Embedding:** A script (run on update) chunks the 18 Protocol Libraries, generates text-embedding-3-large vectors, and upserts to Pinecone with metadata (protocol\_id, module\_tags, category).  
  * **Retrieval:** The NudgeEngine (GCF) and api/chat GCF query Pinecone (e.g., "user has low HRV and reports poor sleep") to find the top-K relevant protocol chunks.  
  * **Generation:** The retrieved chunks \+ user context are fed into a **GPT-5** prompt (see Sec 5.0) to generate the personalized nudge text, reasoning, and citation.  
* **Conversational AI Coach (GPT-5):**  
  * This is a two-part system:  
  * **1\. Proactive Nudge Engine (MVP \- MISSION\_006):** This is the NudgeEngine GCF. It runs nightly and on-demand. It gathers context (module\_id, protocol\_logs, wearable data), uses RAG, and generates a structured JSON nudge. This nudge is *pushed* to the user's live\_nudges queue in Firestore and logged in ai\_audit\_log.  
  * **2\. Reactive Chat Service (Phase 2 \- MISSION\_030):** This is the POST /api/chat GCF, triggered by the user. It orchestrates a **5-step LangChain chain** (see MISSION\_030) involving intent detection, secure context retrieval (with PHI de-identification), RAG, personalized response generation, and a final safety/compliance check. The response is written to the conversations subcollection in Firestore and logged in ai\_audit\_log.  
* **Module-Aware Onboarding:**  
  * User signs up (Firebase Auth).  
  * User sees a screen of the 6 MVP Modules (Focus, Sleep, etc.).  
  * User selects 1 primary module (e.g., "Sleep Optimization").  
  * Backend creates User record, starts 14-day trial, and creates a ModuleEnrollment for "Sleep."  
  * Backend immediately schedules the starterProtocols for that module (e.g., "Morning Light" and "Evening Wind-Down"), delivering the "First Win" nudge in \<5 minutes.  
* **Simplified MVP UX:**  
  * **Protocol Content:** Protocol detail screens will *not* have rich media. They will show:  
    1. Name: "Morning Light Exposure"  
    2. Simple Summary: "2-3 bullet points on why this matters."  
    3. Evidence Link: "Tap to see 3-5 external studies" (links to PubMed/DOI).  
  * **Feedback:** All nudges and completed protocols will have a simple **"👍 / 👎"** UI. Tapping either logs to ai\_audit\_log. An optional "Add comment" field appears after tapping.

---

## **3.0 Module Framework & Protocol Orchestration**

### **3.1 MVP Life Domains (Modules)**

The MVP will launch with 6 user-facing Modules. These are the *only* way users browse and engage with the app's content.

1. **Sleep Optimization (Core Tier):**  
   * **Outcome:** Faster sleep onset, better quality, wake consistency.  
   * **Metrics:** Sleep Quality Score, Sleep Latency, Module Streak.  
   * **Starter Protocols:** Morning Light, Evening Light Management, NSDR Session.  
2. **Morning Routine (Core Tier):**  
   * **Outcome:** Reliable morning anchor, elevated energy and mood.  
   * **Metrics:** Routine Completion %, Module Streak, Subjective Energy.  
   * **Starter Protocols:** Morning Light, Hydration, Morning Movement.  
3. **Focus & Productivity (Core Tier):**  
   * **Outcome:** More deep-work minutes, fewer distractions, consistent output.  
   * **Metrics:** Focus Blocks/day, Module Streak.  
   * **Starter Protocols:** Caffeine Timing, Breathwork (Box Breathing), Deep Work Protocols.  
4. **Stress & Emotional Regulation (Pro Tier):**  
   * **Outcome:** Reduced acute anxiety, higher baseline HRV, calm-on-demand.  
   * **Metrics:** HRV Trend, Subjective Stress, Module Streak.  
   * **Starter Protocols:** NSDR Session, Breathwork (Cyclic Sighing), Gratitude Practice.  
5. **Energy & Recovery (Pro Tier):**  
   * **Outcome:** Higher readiness, stable daytime energy, better post-workout recovery.  
   * **Metrics:** Readiness Score (from wearable), Subjective Energy, Module Streak.  
   * **Starter Protocols:** Cold Exposure, Movement Snacks, Hydration.  
6. **Dopamine Hygiene (Pro Tier):**  
   * **Outcome:** Less compulsive scrolling, better attention control, restore reward sensitivity.  
   * **Metrics:** Screen Time (manual log), Module Streak.  
   * **Starter Protocols:** Digital Sunset (Evening Light), Screen-Time Blocks, Information Diet.

### **3.2 Cross-Domain Protocol Matrix (MVP)**

This matrix defines the many-to-many relationship. Protocols are reusable assets.

| Protocol (Action) | Powers Module: Focus | Powers Module: Sleep | Powers Module: Morning | Powers Module: Stress | Powers Module: Energy | Powers Module: Dopamine |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- |
| **Morning Light** |  | ✅ | ✅ |  | ✅ | ✅ |
| **Evening Light** |  | ✅ |  | ✅ |  | ✅ |
| **Caffeine Timing** | ✅ | ✅ |  |  |  |  |
| **Movement Snacks** | ✅ |  |  |  | ✅ |  |
| **Hydration** |  |  | ✅ |  | ✅ |  |
| **NSDR Session** | ✅ | ✅ |  | ✅ | ✅ |  |
| **Breathwork** | ✅ |  |  | ✅ |  |  |
| **Cold Exposure** |  |  | ✅ | ✅ | ✅ | ✅ |
| **Deep Work** | ✅ |  |  |  |  | ✅ |
| **Gratitude Practice** |  |  | ✅ | ✅ |  |  |

### **3.3 Tier Distribution & Unlocking (MANDATORY UPDATE)**

* **14-Day Free Trial (No CC Required):**  
  * **Full Core Tier Access.**  
  * Access to **3 Modules** (Sleep, Morning Routine, Focus).  
  * Access to **8 Core Protocols** (e.g., Morning Light, Evening Light, Caffeine Timing, Hydration, Breathwork, NSDR, Deep Work, Morning Movement).  
  * **AI Coach (Limited):** Proactive nudges \+ **10 conversational queries/week**.  
  * **Apple Health / Google Fit** integration.  
  * Streaks, progress tracking, weekly insights, Evidence UX.  
* **Tier 1 (Core \- $29/mo or $249/yr):**  
  * All features from the trial.  
  * This is the paid plan that continues the trial experience.  
  * **AI Coach (Limited):** Proactive nudges \+ **10 conversational queries/week**.  
* **Tier 2 (Pro \- $59/mo or $499/yr):**  
  * All Core features.  
  * Unlocks **all 17 protocols** (e.g., Cold Exposure, Advanced Supplementation).  
  * Unlocks **all 6 MVP Modules** \+ early access to new modules.  
  * **AI Coach (Unlimited):** **Unlimited** nudges and **unlimited** conversational chat.  
  * Advanced analytics (protocol effectiveness, HRV trends).  
  * **Direct Oura/Whoop integration (Phase 2).**  
  * Data export (CSV).  
  * *(Waitlist available at MVP launch).*  
* **Tier 3 (Elite \- $99/mo or $799/yr):**  
  * All Pro features.  
  * Custom AI Coach personality.  
  * API access for integrations (Phase 3).  
  * Experimental Labs protocols.  
  * 1:1 certified coach session/month (Phase 3).  
  * Priority support.  
  * *(Waitlist available at MVP launch).*

---

## **4.0 Mission Catalog (Phase 1: MVP)**

*25 discrete missions for the MVP, sequenced by dependency.*

### **Foundation (Week 1\)**

**MISSION\_001: Foundational Infrastructure Setup**

* **Phase:** MVP  
* **Goal:** Establish core cloud infra: GCP Project, Firebase (Auth, Firestore, Storage, GCF), Supabase (Postgres), Pinecone, and API Gateway.  
* **System Context:** Root mission. Feeds into all others.  
* **Core Requirements:** Provision all services. Configure Firebase Auth as primary IdP. Set up GCF environment (Node.js/TS). Configure Supabase RLS to accept Firebase JWTs.  
* **Acceptance Criteria:** All services are provisioned. A test GCF can validate a Firebase JWT and query the Supabase users table successfully using RLS.

**MISSION\_002: User Authentication & Profile API**

* **Phase:** MVP  
* **Goal:** Implement user signup (Email, Google, Apple), login, and a secure /api/users/me endpoint.  
* **System Context:** Depends on MISSION\_001. Feeds into MISSION\_003.  
* **Core Requirements:** Use Firebase Auth SDK on client. On signup, GCF trigger creates shadow User record in Supabase (with healthMetrics JSONB). Create GCF endpoints: POST /api/users (on signup), GET /api/users/me, PATCH /api/users/me.  
* **Acceptance Criteria:** User can sign up, log in. GET /api/users/me returns the correct user's data from Supabase. PATCH updates display\_name.

**MISSION\_003: Module-Aware Onboarding Flow**

* **Phase:** MVP  
* **Goal:** Implement the \< 3 min onboarding flow: user selects primary Module, 14-day trial starts, and first-win protocols are scheduled.  
* **System Context:** Depends on MISSION\_002, MISSION\_009. Feeds into MISSION\_010.  
* **Core Requirements:**  
  1. Client fetches modules list from Supabase (where tier \= 'core').  
  2. User selects 1 primary Module (e.g., "Sleep").  
  3. Client calls POST /api/onboarding/complete with primary\_module\_id.  
  4. Backend updates User (sets trial\_start\_date, trial\_end\_date), creates ModuleEnrollment, and triggers MISSION\_010 logic to schedule starterProtocols.  
* **Acceptance Criteria:** User can select a module. User and ModuleEnrollment tables are populated. Trial dates are set. First-win protocol is scheduled in \< 1 minute.

**MISSION\_004: Protocol Engine \- Daily Scheduler**

* **Phase:** MVP  
* **Goal:** Implement the nightly batch job (GCF) to generate a personalized, conflict-free daily schedule for each user *based on their modules*.  
* **System Context:** Depends on MISSION\_003. Feeds into MISSION\_011.  
* **Core Requirements:**  
  1. Nightly Pub/Sub GCF (generateDailySchedules).  
  2. Fetches all active ModuleEnrollments.  
  3. For each user, fetches their enrolled protocols (via ModuleProtocolMap, filtered by user.tier).  
  4. Calculates optimal timing (using user.preferences, SunCalc, and protocol library constraints).  
  5. Writes the final schedule (with module\_id context) to **Firestore** at /schedules/{user\_id}/{YYYY-MM-DD}.  
* **Acceptance Criteria:** GCF runs nightly. A correct schedule is generated in Firestore for each active user, respecting their *enrolled module's* protocols and personal times.

**MISSION\_005: Protocol RAG Pipeline Setup**

* **Phase:** MVP  
* **Goal:** Establish the Pinecone index and embedding pipeline for all 18 protocols.  
* **System Context:** Depends on MISSION\_001, MISSION\_009. Feeds into MISSION\_006.  
* **Core Requirements:** Create Pinecone index. Create a GCF (embedProtocols) that runs on protocols table updates. GCF chunks protocol text (from Protocol Libraries), generates text-embedding-3-large vectors, and upserts to Pinecone with metadata (protocol\_id, module\_tags).  
* **Acceptance Criteria:** Pinecone index is populated with vectors for all 18 protocols. Metadata is filterable.

**MISSION\_006: Adaptive Coach (Proactive Nudge Engine)**

* **Phase:** MVP  
* **Goal:** Implement the core *proactive AI nudge* generation service using GPT-5 and the RAG pipeline, *adhering to the professional tone*. (Note: Two-way chat is Phase 2, MISSION\_030).  
* **System Context:** Depends on MISSION\_005, MISSION\_015. Feeds into MISSION\_007, MISSION\_011.  
* **Core Requirements:**  
  1. Create GCF (generateAdaptiveNudges) triggered by Pub/Sub (nightly and on-demand).  
  2. Gathers context: User profile, primary module\_id, recent protocol\_logs, wearable data (hrv, sleep\_hours).  
  3. Queries Pinecone for relevant protocol context (RAG).  
  4. Calls **OpenAI GPT-5** with full context, RAG results, and the **professional system prompt** (see Sec 5.0).  
  5. Implements fallback logic (Rule-based \-\> Cached).  
  6. Writes nudge (with module\_id context) to Firestore /live\_nudges/{user\_id} and logs to Supabase ai\_audit\_log (using the V3.2 extended schema).  
* **Acceptance Criteria:** GPT-5 is called with correct context. A personalized, *professional-toned*, evidence-based nudge is generated. Nudge references the user's module goal.

**MISSION\_007: AI Audit & Feedback (Thumbs Up/Down)**

* **Phase:** MVP  
* **Goal:** Log all AI decisions (nudges *and* chat) and capture simple "thumbs up/down" user feedback, using the V3.2 extended schema.  
* **System Context:** Depends on MISSION\_006. Feeds into MISSION\_008.  
* **Core Requirements:**  
  1. MISSION\_006 must write a full record to the ai\_audit\_log (Supabase) for every nudge generated, populating fields like context\_sources, safety\_flags, etc.  
  2. Create GCF endpoint: POST /api/feedback/nudge/{nudge\_id}.  
  3. API accepts { feedback: 'thumb\_up' | 'thumb\_down', text?: string }.  
  4. API updates the corresponding ai\_audit\_log record.  
* **Acceptance Criteria:** All generated nudges are logged with the extended V3.2 schema. User feedback is successfully captured and stored in the audit log.

**MISSION\_008: Continuous Learning Engine (Stub)**

* **Phase:** MVP  
* **Goal:** Implement the *stub* for the continuous learning engine. Full implementation is Phase 2, but the data must be collected in MVP.  
* **System Context:** Depends on MISSION\_007.  
* **Core Requirements:** Create a weekly GCF (analyzeNudgeFeedback). In MVP, this function *only* aggregates ai\_audit\_log feedback (counts of thumbs up/down per protocol/module) and logs a summary report for the product team.  
* **Acceptance Criteria:** Weekly job runs and generates a report (e.g., in GCF logs or Slack) of nudge feedback metrics.

**MISSION\_009: Module & Protocol Definition**

* **Phase:** MVP  
* **Goal:** Seed the Supabase DB with all 6 MVP Modules and 18 Protocols, and map them.  
* **System Context:** Root data mission. Feeds into MISSION\_003, MISSION\_004, MISSION\_005.  
* **Core Requirements:**  
  1. Create modules, protocols, and module\_protocol\_map tables in Supabase.  
  2. Write a seed script to populate modules with the 6 MVP Life Domains (setting tier, starterProtocols, outcomeMetric).  
  3. Seed protocols with all 18 protocols from the Protocol Libraries.  
  4. Populate module\_protocol\_map based on the Cross-Domain Matrix (Sec 3.2), marking is\_starter\_protocol flags.  
* **Acceptance Criteria:** All 3 tables are populated correctly. modules table includes tier and starter protocol data.

### **Core UX & First Win (Week 2\)**

**MISSION\_010: First-Win Nudge Delivery**

* **Phase:** MVP  
* **Goal:** Deliver the user's first protocol nudge within 5 minutes of completing onboarding.  
* **System Context:** Depends on MISSION\_003. Feeds into MISSION\_011, MISSION\_017.  
* **Core Requirements:**  
  1. Triggered by POST /api/onboarding/complete.  
  2. Logic identifies the starterProtocols for the user's chosen primary\_module\_id.  
  3. Selects the *most* actionable one (e.g., if "Focus" module, schedule a "Deep Work" block *now*).  
  4. Writes this single, high-priority nudge to Firestore /live\_nudges/{user\_id}.  
* **Acceptance Criteria:** A relevant nudge appears in the app \< 5 minutes after module selection.

**MISSION\_011: Client UI (Professional Health Dashboard)**

* **Phase:** MVP  
* **Goal:** Implement the client-side UI based on the "Whoop/Headspace" professional design spec (Sec 5.1).  
* **System Context:** Depends on MISSION\_004, MISSION\_006, MISSION\_010.  
* **Core Requirements:**  
  1. Implement Bottom Nav (Home, Protocols, Insights, Profile).  
  2. **Home Screen:** Must be a *Health Dashboard*, not a game screen. Display health outcome charts (Sleep Quality, HRV) and ModuleEnrollment cards (showing progressPct rings and currentStreak).  
  3. Listen to Firestore /schedules/ and /live\_nudges/ to populate the Home Screen task list.  
  4. **V3.2:** Implement the **AI Coach Quick Access Button** in the top bar (see Sec 5.2). Tapping it opens the chat interface (MISSION\_030).  
  5. UI *must* use the V3.2 color palette, typography, and minimal animations (haptics, checkmarks).  
  6. *No* XP bars, leaderboards, or game-like elements.  
* **Acceptance Criteria:** Client UI matches Sec 5.1 spec. Home screen is a data-driven dashboard. Live nudges appear. AI chat button is present.

**MISSION\_012: Protocol RAG API (Search Stub)**

* **Phase:** MVP  
* **Goal:** Create the API endpoint for the client to search protocols (full RAG-chat is Phase 2).  
* **System Context:** Depends on MISSION\_005.  
* **Core Requirements:** Create GCF endpoint GET /api/protocols/search?q={query}. API generates an embedding for the query, queries Pinecone for top-K protocol\_ids, fetches full protocol data from Supabase, and returns a ranked list.  
* **Acceptance Criteria:** API returns relevant protocols from a text query (e.g., "sleep" returns Morning Light, Evening Light, etc.).

**MISSION\_013: Evidence UX (Simple Bullets)**

* **Phase:** MVP  
* **Goal:** Implement the simplified "2-3 bullet" protocol content UX, as per the Change Log.  
* **System Context:** Depends on MISSION\_009.  
* **Core Requirements:**  
  1. Protocol detail screens *must not* contain rich media.  
  2. Display: Protocol Name, 2-3 bullet point summary (from protocols.description).  
  3. Display a link/button: "View Evidence."  
  4. Tapping "View Evidence" opens a simple list of external links (DOIs) from the citations table.  
* **Acceptance Criteria:** Protocol content is simple text. Evidence is presented as external links, not in-app summaries.

### **Data & Adherence (Week 3\)**

**MISSION\_014: Basic Wearable Integration (Aggregators)**

* **Phase:** MVP  
* **Goal:** Implement client-side integration with **Apple Health (HealthKit)** and **Google Fit** *only*.  
* **System Context:** Depends on MISSION\_003. Feeds into MISSION\_015.  
* **Core Requirements:**  
  1. Integrate React Native libraries for HealthKit and Google Fit.  
  2. Request permissions *after* the First Win (Day 2 or 3).  
  3. Implement functions to read *only* Sleep, HRV (RMSSD/SDNN), RHR, and Steps.  
  4. Batch-send this data to POST /api/wearables/sync.  
* **Acceptance Criteria:** App successfully requests and reads data from HealthKit and Google Fit. Data is sent to the backend API.

**MISSION\_015: Wearable Data Ingestion & Normalization**

* **Phase:** MVP  
* **Goal:** Implement the backend API to receive, normalize, and store data from aggregators.  
* **System Context:** Depends on MISSION\_014. Feeds into MISSION\_006.  
* **Core Requirements:**  
  1. Create GCF endpoint: POST /api/wearables/sync.  
  2. Receives batched data from clients.  
  3. Normalizes differing metrics (e.g., HealthKit SDNN vs. Google Fit RMSSD) into a common format.  
  4. Writes normalized data to wearable\_data\_archive (Supabase) for long-term analysis.  
  5. *Trigger* an update to the User.healthMetrics JSONB with new trend data.  
* **Acceptance Criteria:** API correctly ingests and normalizes data. Data is stored in wearable\_data\_archive and aggregated in User.healthMetrics.

**MISSION\_016: Biometric Security (Face ID/Touch ID)**

* **Phase:** MVP  
* **Goal:** Implement secure app access using native biometrics.  
* **System Context:** Depends on MISSION\_002.  
* **Core Requirements:**  
  1. Use native React Native libraries for Face ID/Touch ID (iOS) and BiometricPrompt (Android).  
  2. Securely store the Firebase refresh token in the device's Keychain/Keystore.  
  3. On app launch, use biometrics to unlock the refresh token, then silently refresh the session.  
  4. Implement PIN fallback.  
* **Acceptance Criteria:** App is locked on launch. Biometric prompt unlocks the app. Session is refreshed securely.

**MISSION\_017: Protocol Logging & Engagement Update**

* **Phase:** MVP  
* **Goal:** Allow users to log protocol completion (with offline support) and trigger all engagement mechanics.  
* **System Context:** Depends on MISSION\_011. Feeds into MISSION\_019, MISSION\_006.  
* **Core Requirements:**  
  1. When user taps "Log Complete" in the client:  
     * Write the log *directly to a local Firestore queue* (Firestore offline support).  
     * Client UI shows a simple checkmark \+ haptic feedback.  
  2. Create a GCF (onProtocolLogWritten) triggered by Firestore writes to /schedules/{user\_id}/{date}.  
  3. This GCF writes the canonical log to the protocol\_logs table in **Supabase**.  
  4. The GCF *then* updates the ModuleEnrollment table: currentStreak++, progressPct, lastActiveDate.  
  5. The GCF also checks for and grants milestone badges (e.g., 30-day streak) by updating User.earnedBadges.  
* **Acceptance Criteria:** User can log protocols offline. Logs sync and trigger streak/progress/badge updates in Supabase. UI feedback is minimal and professional.

**MISSION\_018: Privacy Dashboard & Data Export**

* **Phase:** MVP  
* **Goal:** Provide GDPR/HIPAA compliance features: data view, export, and deletion.  
* **System Context:** Depends on MISSION\_007, MISSION\_015, MISSION\_017.  
* **Core Requirements:**  
  1. Client UI ("Privacy Dashboard") to view data from protocol\_logs and ai\_audit\_log.  
  2. **V3.2:** Add "Download my chat history" and "Delete all conversations" buttons (ties into MISSION\_030).  
  3. GCF endpoint POST /api/users/me/export (triggers async GCF to query all user data from Supabase, zip it, and email a download link).  
  4. GCF endpoint DELETE /api/users/me (triggers anonymization/deletion workflow).  
* **Acceptance Criteria:** User can view their log history. Data export works. Account deletion works.

### **Growth & Launch (Week 4\)**

**MISSION\_019: Streaks, Progress & Engagement Logic**

* **Phase:** MVP  
* **Goal:** Implement the backend logic for module-level streaks, progress, and badges.  
* **System Context:** Depends on MISSION\_017. Feeds into MISSION\_020.  
* **Core Requirements:**  
  1. Nightly GCF (calculateStreaks).  
  2. Checks ModuleEnrollment.lastActiveDate. If \> 24h, check streakFreezeAvailable.  
  3. If freeze available: set streakFreezeAvailable \= false, streakFreezeUsedDate \= now(). Send "Streak Preserved" nudge.  
  4. If no freeze: reset currentStreak \= 0\. Send "Lapse Recovery" nudge.  
  5. Weekly GCF (resetFreezes): Resets streakFreezeAvailable \= true every Monday.  
  6. (MISSION\_017 handles streak increments and badge logic).  
* **Acceptance Criteria:** Streaks are calculated *per module*. Freeze logic works automatically. Badges are granted on milestones.

**MISSION\_020: Paywall & 14-Day Trial Logic**

* **Phase:** MVP  
* **Goal:** Implement the 14-day trial conversion flow and paywall for the $29/mo Core tier.  
* **System Context:** Depends on MISSION\_003, MISSION\_019. Feeds into MISSION\_023.  
* **Core Requirements:**  
  1. Onboarding (MISSION\_003) sets trial\_end\_date (14 days from trial\_start\_date).  
  2. Client UI shows a persistent banner "X days left in your trial."  
  3. **Day 7:** Show a soft modal: "You've built momentum\! See how much progress you've made." (Shows health metrics).  
  4. **Day 14 (Trial End):** Show hard paywall for the **$29/mo Tier 1 (Core)** plan. Emphasize health outcomes ("Users improve sleep 23% in 30 days").  
  5. Paywall is also triggered when user tries to access a Pro module (e.g., "Stress & Regulation") or exceeds their **10-query/week chat limit**.  
* **Acceptance Criteria:** Trial starts and ends correctly. Paywall displays the $29 price. Conversion strategy (Day 7/14) is implemented. Chat limit triggers the paywall.

**MISSION\_021: Tier 2/3 Waitlist**

* **Phase:** MVP  
* **Goal:** Implement the waitlist feature to capture demand for Pro ($59) and Elite ($99) tiers.  
* **System Context:** Depends on MISSION\_001.  
* **Core Requirements:**  
  1. Client UI shows Pro/Elite modules (e.g., "Stress," "Energy") as "Locked."  
  2. Tapping them shows a "Coming Soon" screen with value props (e.g., "**Unlimited AI Chat**," "Advanced Analytics").  
  3. Include an email input field.  
  4. Create GCF endpoint POST /api/waitlist that saves email and tier\_interested\_in to the waitlist\_entry table (Supabase).  
* **Acceptance Criteria:** User can view Pro/Elite placeholders. User can submit their email to the waitlist. Email is saved in Supabase.

**MISSION\_022: Foundational Analytics (Module-Aware)**

* **Phase:** MVP  
* **Goal:** Implement core Mixpanel event tracking, *with module context*.  
* **System Context:** Depends on all other missions.  
* **Core Requirements:**  
  1. Integrate Mixpanel SDK.  
  2. Track Tier 1 Events: user\_signup, onboarding\_complete (props: primary\_module\_id), protocol\_logged (props: protocol\_id, module\_id, source), paywall\_viewed (props: trigger\_module\_id), subscription\_started.  
  3. **V3.2:** Add ai\_chat\_query\_sent (props: intent\_detected), ai\_chat\_limit\_hit.  
  4. Build Mixpanel dashboards: Onboarding Funnel (by module), Adherence (by module), Conversion Funnel.  
* **Acceptance Criteria:** All Tier 1 events are tracked in Mixpanel with correct properties, including module\_id and chat events.

**MISSION\_023: Subscription Management (RevenueCat)**

* **Phase:** MVP  
* **Goal:** Integrate RevenueCat to handle the $29/mo Core subscription purchase and status.  
* **System Context:** Depends on MISSION\_020.  
* **Core Requirements:**  
  1. Integrate RevenueCat SDK.  
  2. Configure $29/mo (and $249/yr) product in App Store, Play Store, and RevenueCat.  
  3. Client calls RevenueCat.purchasePackage() from the paywall.  
  4. Configure RevenueCat webhook to call a GCF endpoint (POST /api/webhooks/revenuecat).  
  5. Webhook GCF validates the event and updates the User table in Supabase (sets tier \= 'core', subscription\_id).  
* **Acceptance Criteria:** User can purchase the $29/mo plan. Webhook fires and updates the user's tier in Supabase.

**MISSION\_024: Social Features (Deferred)**

* **Phase:** MVP  
* **Goal:** Defer all social features to Phase 2 to focus on the core wellness loop. Implement *only* the anonymous toggle for Phase 2 readiness.  
* **System Context:** Depends on MISSION\_002.  
* **Core Requirements:**  
  1. Add social\_anonymous: boolean to UserPreferences (JSONB in users table).  
  2. Create a setting toggle in the client UI: "Appear anonymously in future social features."  
  3. This toggle updates the user.preferences.social\_anonymous flag via PATCH /api/users/me.  
  4. **No leaderboards, challenges, or social feeds in MVP.**  
* **Acceptance Criteria:** User can toggle their anonymity setting. No social features are built.

**MISSION\_025: CI/CD & Feature Flag Setup**

* **Phase:** MVP  
* **Goal:** Implement GitHub Actions for CI/CD and LaunchDarkly for feature flagging.  
* **System Context:** Depends on MISSION\_001.  
* **Core Requirements:**  
  1. GitHub Actions workflow: on: push (main) \-\> Lint, Test, Deploy GCFs.  
  2. Integrate LaunchDarkly (or Firebase Remote Config) SDK.  
  3. Create feature flags for all 6 MVP Modules (e.g., enable-module-focus, enable-module-stress).  
  4. **V3.2:** Add flag enable-ai-chat (defaults to true for MVP, but allows kill-switch).  
  5. App *must* check flags before displaying modules/features, allowing for a phased rollout.  
* **Acceptance Criteria:** Pushing to main deploys GCFs. All 6 modules and the AI chat are behind feature flags.

---

## **5.0 Engagement Mechanics (Evidence-Based Retention)**

### **Core Principle**

We are a **professional wellness coach** using behavioral psychology, *not* a gamified health app. Retention is driven by intrinsic motivation (measurable health improvements) and supported by gentle, professional extrinsic loops. Our competitors are Whoop and Headspace, not Duolingo.

### **✅ IMPLEMENT (Selective Gamification)**

1. **Streaks with Forgiveness**  
   * **Why:** \#1 retention driver, supports habit formation without guilt.  
   * **Implementation:**  
     * **Module-level streaks** (not just global) tracked in ModuleEnrollment.  
     * **1 auto-freeze per week** (resets Monday), tracked in ModuleEnrollment.  
     * 24-hour grace period if freeze is used.  
     * Gentle 8pm reminder: "Keep your momentum \- 47-day Sleep streak." (No "LAST CHANCE" alarms).  
     * UI: Subtle top bar display "🔥 47-day Sleep streak".  
2. **Progress Tracking (Health Outcomes)**  
   * **Why:** Intrinsic motivation through measurable health improvements.  
   * **Implementation:**  
     * Track real health metrics (HRV, sleep quality, adherence %) in User.healthMetrics.  
     * **NOT** arbitrary points/XP.  
     * Home dashboard shows trending data.  
     * UI: "Sleep Quality: \+18% vs 30 days ago", Module cards with progress rings (adherence %).  
3. **Weekly Insights**  
   * **Why:** Reflective feedback loop supports behavior change.  
   * **Implementation:**  
     * Sunday evening: "Your Week in Review" modal.  
     * Content: Protocol adherence (6/7 days), health trends (HRV up 3%), standout protocol correlation.  
     * Next week suggestion from AI Coach.  
4. **Milestone Badges (4 Total)**  
   * **Why:** Meaningful identity markers, not excessive gamification.  
   * **Badges:**  
     * foundation\_builder: 7-day multi-protocol adherence (Early win).  
     * protocol\_practitioner: 30-day protocol adherence (Habit formation).  
     * transformation\_milestone: \+20% HRV or Sleep improvement (Evidence-based achievement).  
     * long\_term\_mastery: 100-day streak (Identity marker).  
   * UI: Subtle badge display on profile (User.earnedBadges). No full-screen interruptions.

### **Behavioral Psychology Integration**

* **Habit Formation (Cue-Routine-Reward):**  
  * **Cue:** Time-based notifications from scheduler; **V3.2:** Contextual triggers in chat.  
  * **Routine:** Complete protocol (streamlined UX).  
  * **Reward:** Health outcome feedback ("Sleep quality \+8%") and streak increment (haptic \+ checkmark).  
* **Progress Visibility:**  
  * Show real health metrics trending upward (Home Dashboard).  
  * Weekly insights connect protocols to health outcomes.  
* **Loss Aversion (Gentle):**  
  * Streak freeze prevents abandonment.  
  * No guilt messaging ("Resume your streak," not "You failed").  
* **Identity Formation:**  
  * 4 selective badges \= "I'm a Protocol Practitioner."  
  * Long-term streaks align with self-concept.

### **AI Coach System Prompt (V3.2)**

Plaintext

You are a credible wellness coach for performance professionals. Use evidence-based language. Reference peer-reviewed studies when relevant. Celebrate progress based on health outcomes (HRV improvement, sleep quality gains), not arbitrary milestones. Tone is professional, motivational but not cheesy. Address user by name occasionally. Use 🔥 emoji only for streaks (professional standard). No other emojis. **You must not provide medical advice.** You are an educational tool. If a user asks for medical advice, you must decline and append the medical disclaimer.

---

## **5.1 UI/UX Specifications (Core App)**

* **Design Philosophy:** Inspiration: **Whoop** (data-driven) \+ **Headspace** (trustworthy) \+ **Noom** (behavioral science). NOT: Duolingo (playful gaming).  
* **Color Palette:**  
  * Primary: Deep Blue (\#2D5A8C) \- trust, calm.  
  * Accent: Teal (\#00BFA5) \- growth, wellness.  
  * Success: Green (\#4CAF50) \- health improvement.  
  * Alert: Amber (\#FFA726) \- gentle warnings (not red alarms).  
  * Background: White/Light Gray \- clinical clarity.  
* **Typography:**  
  * Headings: SF Pro / Inter (clean, professional).  
  * Body: High readability sans-serif.  
  * Data: Tabular figures for metrics.  
* **Animations (Minimal, Professional):**  
  * Protocol completion: Simple checkmark fade-in \+ haptic feedback.  
  * Streak increment: Subtle flame grow (no explosion).  
  * Badge unlock: Slide-in notification (no full-screen modal).  
* **Layout:**  
  * Bottom Nav: Home, Protocols, Insights, Profile.  
  * Home Screen: Health dashboard (sleep graph, HRV trend, adherence %, module cards).  
  * Top Bar: Streak display (subtle), **AI Coach quick access** (V3.2).  
* **Micro-interactions:**  
  * Button press: Haptic only.  
  * Protocol log: Checkmark fade-in.  
  * Streak display: Gentle pulsing on increment.  
  * NO: Whoosh sounds, celebration music, over-animated transitions.

## **5.2 UI/UX Specifications (V3.2 Conversational UI)**

### **5.2.1 Entry Points**

1. **Primary: AI Coach Quick Access Button (Top Bar)**  
   * **Design:** Floating button with AI sparkle icon, positioned top-right.  
   * **Behavior:** Taps to open a modal bottom sheet (iOS) or full-screen overlay (Android) with the chat interface.  
   * **Rationale:** Persistent access across all tabs, aligning with the "always-on" coach concept (Whoop pattern).  
2. **Contextual Entry Points**  
   * **Home \> Daily Briefing:** Tapping a low recovery score card includes a "Ask AI Coach why" button.  
   * **Insights \> HRV Trend:** "Ask AI Coach about this trend" button.  
   * **Protocols \> Protocol Detail:** "Questions about this protocol?" button.  
   * **Rationale:** Pre-fills the chat context, reducing user friction and leading to more relevant answers.

### **5.2.2 Chat Interface Design**

1. **Top Bar:** "AI Coach" title \+ close button \+ settings (delete history).  
2. **Message Area:**  
   * **User Messages:** Right-aligned, teal bubble (\#00BFA5).  
   * **AI Messages:** Left-aligned, light gray bubble with "🤖 AI-generated" badge.  
   * **Context Cards:** Inline, non-text data visualizations (e.g., "Last Night's Sleep: 6.1hrs 🔻 \-1.9hrs vs goal").  
   * **Citation Cards:** Expandable accordion showing study details \+ DOI link for evidence-grounded responses.  
3. **Input Area:** Text field with voice input button \+ send button.

### **5.2.3 Mobile UX Best Practices**

* **One Sentence Per Bubble:** Break long AI responses into digestible, sequential chunks to mimic conversation (Noom pattern).  
* **Progressive Disclosure:** Use "Learn more" buttons to expand detailed evidence (like Citation Cards) without overwhelming the user.  
* **Haptic Feedback:** Gentle vibration on message send \+ receive.  
* **Accessibility:** Support dynamic type scaling and full VoiceOver/TalkBack compatibility.

---

## **6.0 Monetization & Growth**

* **Business Model:** 14-day free trial of Tier 1 (Core), then paid subscription. No freemium tier.  
* **Pricing (MANDATORY V3.2):**  
  * **Tier 1 (Core): $29/month** (or $249/year \- $20.75/mo, 29% savings)  
    * Access to 3 Core Modules (Sleep, Morning, Focus) & 8 Core Protocols.  
    * **AI Coach (Limited):** Proactive nudges \+ **10 conversational queries/week**.  
    * Apple Health / Google Fit.  
    * Streaks, Progress, Weekly Insights.  
  * **Tier 2 (Pro): $59/month** (or $499/year \- $41.58/mo, 30% savings)  
    * **AI Coach (Unlimited):** **Unlimited** proactive nudges and **unlimited** conversational chat.  
    * All 17 Protocols & All 6 Modules.  
    * Advanced Analytics.  
    * Direct Oura/Whoop (Phase 2).  
  * **Tier 3 (Elite): $99/month** (or $799/year \- $66.58/mo, 33% savings)  
    * All Pro features \+ 1:1 Coaching (Phase 3\) & Custom AI.  
* **Conversion Funnel:**  
  1. **Acquisition:** User downloads app, starts 14-day trial (no CC), selects primary module.  
  2. **Activation:** User experiences "First Win" nudge (\<5 min) and completes first protocol.  
  3. **Engagement:** User sees health outcome data (Day 7 soft modal) and builds a module streak. User engages with the limited AI chat.  
  4. **Conversion:** At Day 14 *or* when the 10-query chat limit is hit, a hard paywall shows. User converts to **$29/mo Core** plan.  
  5. **Upsell:** Engaged Core users are prompted to upgrade to Pro ($59) to unlock other modules (e.g., "Stress") and, most importantly, **unlimited AI chat**.  
* **Waitlist Strategy:** The MVP *must* actively market the Pro ($59) and Elite ($99) tiers as "Locked." Tapping these features/modules (or the "Upgrade for Unlimited Chat" prompt) prompts the user to join the waitlist, building a high-intent funnel for the Phase 2 launch.  
* **Success Metrics (Realistic Targets):**  
  * **Engagement:** Day 30 Retention: 35%+. DAU/MAU: 50%+ (Whoop/Headspace range).  
  * **Conversion:** Trial → Paid: 15-18% (driven by health outcome value).  
  * **Health Outcomes (Primary):** Sleep quality improvement: \+15-20% by Day 30\. Protocol adherence: 5+ days/week for 40%+ users.  
  * **V3.2 Target:** Phase 2 Chat rollout to drive **\+12-18% adherence lift** for engaged chat users.

---

## **7.0 Launch & Operations**

* **Go-to-Market:** Product-led growth. Target 1,000 beta users (Month 1\) via Product Hunt, Reddit (r/HubermanLab, r/biohacking), and targeted micro-influencers. The waitlist for Pro/Elite will be a key marketing asset.  
* **Feature Flags:** All 6 MVP Modules will be behind feature flags. MVP launch will enable the 3 'Core' modules (enable-module-sleep, enable-module-focus, enable-module-morning) and *disable* the 3 'Pro' modules. enable-ai-chat will be on for all users.

### **7.1 Security, Compliance & Ethical AI (V3.2)**

* **HIPAA & BAA (Business Associate Agreement):**  
  * A signed BAA is required for GCP, Supabase, and **OpenAI (GPT-5)**.  
  * **MANDATORY:** All calls to OpenAI *must* use the **Zero-Data-Retention API tier**. Standard 30-day retention is not HIPAA-compliant.  
  * This is a non-negotiable prerequisite for launching MISSION\_030.  
* **PHI De-identification:**  
  * To minimize PHI exposure, a GCF proxy layer must be built.  
  * Before constructing a prompt for GPT-5, this layer must pseudonymize direct identifiers.  
  * **Example:** "John Doe's HRV is 58ms" becomes "User \[uid:a7b9c3\]'s HRV is 58ms".  
  * The mapping is stored in the secure phi\_mappings Firestore collection.  
* **Encryption & Access:**  
  * All PHI (logs, wearables, chat history) encrypted at rest (Firestore/Supabase automatic) and in transit (TLS 1.3).  
  * Supabase RLS (auth.uid() \= user\_id) and Firestore Rules (request.auth.uid \== userId) enforce data access.  
* **Ethical AI Safeguard Implementation (7-Layer System):**  
  * The api/chat GCF (MISSION\_030) *must* include this 7-layer safety chain:  
  1. **Medical Advice Disclaimer Automation:** If intent \= safety\_query or medical keywords are detected, *append* the disclaimer: "⚠️ **Important**: This is educational information, not medical advice. Consult your healthcare provider."  
  2. **Crisis Detection & Escalation:** Rule-based filter \+ GPT-5 sentiment. If suicidal or self-harm language is detected, pause chat and display crisis resources (988 Suicide & Crisis Lifeline).  
  3. **Transparency Markers:** All AI responses badged "🤖 AI-generated". First-time user modal explains AI limitations.  
  4. **Citation Verification:** Post-generation check of GPT-5-provided DOIs against PubMed/CrossRef APIs. If a DOI is invalid, remove the citation and flag it as a potential hallucination in the ai\_audit\_log.  
  5. **Bias Monitoring:** Monthly audit (run by humans) of 100 random chat responses (flagged by a bias-detection model) to check for demographic bias.  
  6. **Human Escalation:** Offer "Talk to a human coach" button if user frustration is detected ("This isn't helping") or if a complex medical context is flagged. This routes to a Pro tier upsell or support ticket.  
  7. **Consent & Data Control:** First-launch modal gets explicit consent for AI data analysis. Privacy Dashboard (MISSION\_018) provides data export and deletion.

---

## **8.0 Phased Rollout Plan**

### **Phase 1: MVP (Month 1\)**

*Goal: Launch a stable, 14-day trial app with 3 core modules, AI nudges (GPT-5), limited AI chat, professional UX, and a waitlist for premium tiers. Achieve 1,000 beta users and 15%+ conversion.*

* **Week 1 (Foundation):** M\_001 (Infra), M\_002 (Auth), M\_009 (Modules/Protocols), M\_016 (Biometrics), M\_025 (CI/CD, Flags).  
* **Week 2 (Core Loop):** M\_003 (Onboarding), M\_004 (Scheduler), M\_005 (RAG), M\_006 (Nudge Engine), M\_007 (Audit), M\_010 (First Win), M\_011 (Client UI \- Dashboard \+ Chat Button).  
* **Week 3 (Data & Adherence):** M\_013 (Evidence UX), M\_014 (Wearables Client), M\_015 (Wearables Ingestion), M\_017 (Logging), M\_019 (Streaks & Engagement).  
* **Week 4 (Launch & Growth):** M\_012 (Search API), M\_018 (Privacy), M\_020 (Paywall \+ Chat Limit), M\_021 (Waitlist), M\_022 (Analytics \+ Chat Events), M\_023 (Subscription), M\_024 (Social Toggle).  
* **Launch Day (End of Week 4):** Enable feature flags for the 3 'Core' modules and enable-ai-chat. Launch on Product Hunt.

### **Phase 2: Pro (Month 2-5)**

*Goal: Launch Tier 2 (Pro @ $59/mo) to the waitlist. Add direct wearable APIs, unlock all 6 modules, and scale the AI Chat infrastructure.*

* M\_026: Direct Wearable API Integration (Oura, Whoop).  
* M\_027: Social Features (Private 1:1 Challenges, Anonymous Sharing).  
* M\_028: Enable Pro Modules (M\_025 feature flags).  
* M\_029: Advanced Analytics Dashboard (Client-facing).  
* **M\_030: Conversational AI Coach (GPT-5 Chat)**  
  * **Phase:** 2 (This is a V3.2 detailed mission)  
  * **Goal:** Implement the full, two-way, HIPAA-compliant conversational chat service.  
  * **System Context:** Depends on M\_001, M\_005, M\_006. Prerequisite for Tier 2 upsell.  
  * **Core Requirements:**  
    1. **Compliance:** Secure signed **OpenAI BAA** and configure all API calls to the **Zero-Retention Tier**.  
    2. **Backend:** Implement the POST /api/chat GCF.  
    3. **Security:** Implement the **PHI De-identification** proxy layer.  
    4. **Orchestration:** Implement the 5-Step LangChain (TypeScript) prompt chain: Intent Detection \-\> Context Retrieval (Supabase/Firestore) \-\> Evidence Grounding (RAG from Pinecone) \-\> Personalization \-\> Safety Check (7-Layer Safeguards).  
    5. **Data:** Implement Firestore users/{userId}/conversations subcollection for chat memory.  
    6. **Safeguards:** Fully implement the 7-Layer Ethical Safeguard System (Crisis detection, disclaimers, citation verification, etc.) within the GCF.  
    7. **Frontend:** Build the full chat UI (Sec 5.2) including bubbles, Context Cards, and Citation Cards.  
    8. **Monetization:** Link the unlimited chat feature to the **Tier 2 (Pro)** paywall and enforce the rate limit for Tier 1 users.  
  * **Acceptance Criteria:** A user can have a multi-turn, RAG-grounded, HIPAA-compliant conversation. All 7 safeguards are functional. The Pro upsell is triggered correctly.

### **Phase 3: Elite (Month 6+)**

*Goal: Launch Tier 3 (Elite @ $99/mo). Add 1:1 coaching and advanced modules.*

* M\_031: 1:1 Coaching Interface (Calendly/Zoom).  
* M\_032: New Module: Fitness Optimization (from Protocol Library).  
* M\_033: New Module: Supplement Optimization (from Protocol Library).  
* M\_034: Full Continuous Learning Engine (using ai\_audit\_log feedback).

---

## **9.0 Open Questions & Flags**

* ⚠️  
  $$HUMAN DECISION REQUIRED$$  
  : Primary Module Selection: Should the user be limited to one primary module during onboarding, or can they select 1-3?  
  * **Recommendation:** Limit to **one** primary module. This simplifies the "First Win" path and reduces cognitive load. Users can enroll in other modules from the dashboard after onboarding.  
* ⚠️  
  $$HUMAN DECISION REQUIRED$$  
  : 14-Day Trial Scope: Does the 14-day trial give access to all Core features (all 8 protocols) or just the starter protocols for the selected module?  
  * **Recommendation:** Trial must provide **full Tier 1 (Core) access** (3 modules, 8 protocols, limited chat). A trial limited to a single module will not provide enough value to justify the $29/mo price point and will lead to low conversion.  
* ✅  
  $$\[RESOLVED V3.2\]$$  
  : GPT-5 BAA Status: (MISSION\_006) Verify that OpenAI offers a HIPAA BAA for its GPT-5 models as of October 2025\.  
  * **Resolution:** Yes. Research 2 confirms **OpenAI provides BAAs** for API customers. This is a non-negotiable legal and procurement step. The architecture *must* use their **zero-data-retention endpoints** to remain compliant. This is a prerequisite for MISSION\_030.  
* ⚠️  
  $$FLAG FOR GEMINI$$  
  : HRV Normalization: (MISSION\_015) The wearable aggregators provide different HRV metrics (SDNN vs. RMSSD). The normalization logic must be robust. Perplexity Research Prompt: "What is the most scientifically valid method in 2025 to normalize Apple Health's SDNN and Google Fit's RMSSD HRV data into a single, comparable daily readiness score for a wellness app?"  
* ⚠️  
  $$FLAG FOR GEMINI$$  
  : Protocol Conflict Logic: (MISSION\_004) The daily scheduler must resolve conflicts (e.g., Cold Exposure vs. Intense Workout timing). Perplexity Research Prompt: "Based on the provided Protocol Libraries (Part 1 & 2), identify the top 5 potential timing conflicts between protocols and suggest a priority-based resolution rule for each."

---

✅ **V3.2 Enhancement Complete: Conversational AI (RAG chat), HIPAA compliance architecture, 7-layer safety net, and $29/$59/$99 pricing (limited/unlimited chat) integrated.**

**END OF MASTER BLUEPRINT**