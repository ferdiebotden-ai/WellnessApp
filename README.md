# Wellness OS Infrastructure & Development

## Overview
Wellness OS V3.2 is a HIPAA-compliant health and wellness management platform. This repository contains the complete codebase including infrastructure provisioning, backend services, and frontend application.

---

## Local Development Setup (WSL2)

**Environment:** WSL2 + Ubuntu 24.04 + VS Code Remote

### Prerequisites
- Windows 11 with WSL2 enabled
- Ubuntu 24.04 installed in WSL
- VS Code with "WSL" extension
- Node.js v20+ (via nvm)

### Quick Start
```bash
# Open project (use desktop shortcut "WellnessApp (WSL)" or from terminal):
cd ~/projects/WellnessApp && code .

# Install dependencies (first time only)
npm install
cd client && npm install --legacy-peer-deps && cd ..
cd functions && npm install && cd ..

# Start the Expo dev server
cd client && npx expo start

# Run type checking
cd client && npx tsc --noEmit
```

### Available CLIs
All development tools are installed in WSL:
- `claude` - Claude Code AI assistant
- `firebase` - Firebase CLI
- `supabase` - Supabase CLI
- `gcloud` - Google Cloud SDK
- `gh` - GitHub CLI

### Project Location
```
WSL Path: /home/ferdi/projects/WellnessApp
Windows:  \\wsl$\Ubuntu\home\ferdi\projects\WellnessApp
```

---

## Repository Structure

```
frontend/          # Next.js 14 application (App Router)
functions/         # Google Cloud Functions (Node.js 20 + TypeScript)
tests/             # All test files (Jest for backend, Playwright for E2E)
infra/             # Terraform configuration for GCP + Firebase
supabase/          # Database migrations, RLS policies, and seeds
scripts/           # Automation scripts for developer tooling
.github/workflows/ # CI/CD automation (GitHub Actions)
```

---

## Development Workflow with OpenAI Codex

This project uses **OpenAI Codex** as an autonomous coding agent integrated with GitHub. Here's how the workflow operates:

### Phase 1: Codex Writes Code (Autonomous)
1. **Human** provides a mission prompt to Codex via ChatGPT web interface
2. **Codex** reads the repository structure and `AGENTS.md` configuration
3. **Codex** writes production code (GCFs, APIs, React components)
4. **Codex** writes test files (Jest `.test.ts` for backend, Playwright `.spec.ts` for frontend)
5. **Codex** commits changes to a feature branch (`feature/mission-XXX-description`)
6. **Codex** creates a pull request

**Important:** Codex does NOT run tests. It only writes the test files.

### Phase 2: GitHub Actions Runs Tests (Automatic)
1. Pull request creation triggers CI/CD pipeline
2. GitHub Actions installs dependencies (`npm ci`)
3. For frontend missions: Installs Playwright browsers (`npx playwright install`)
4. Runs appropriate test suite:
   - Backend: `npm run test:backend` (Jest)
   - Frontend: `npm run test:ci` (Playwright)
5. Reports test results on the PR

### Phase 3: Human Review & Merge
1. Developer reviews code changes and test results
2. If tests pass and code looks good → Merge PR
3. If tests fail → Request Codex to fix issues

---

## Running Tests Locally (For Humans)

### Backend Tests (Jest)
```bash
npm run test:backend
```

Runs unit and integration tests for Google Cloud Functions.

### Frontend E2E Tests (Playwright)
```bash
# Install browsers first (one-time setup)
npx playwright install --with-deps

# Run tests
npm run test:ci
```

Runs end-to-end tests for user workflows.

### All Tests
```bash
npm run test:backend && npm run test:ci
```

---

## Mission-Based Development

This project follows a mission-based development approach where each feature is defined as a MISSION_XXX in the Blueprint document:

- **MISSION_001-005:** Infrastructure provisioning (Terraform, Firebase, Supabase)
- **MISSION_006-010:** AI coaching engine and adaptive nudging
- **MISSION_011-020:** Feature modules (gamification, analytics, onboarding)
- **MISSION_021-025:** Business and monetization features
- **MISSION_026-030:** Launch, compliance, and advanced AI features

Each mission is assigned to Codex via a requirements-focused prompt generated by Gemini 2.5 Pro.

---

## Key Technologies

### Backend
- **Google Cloud Functions** (Node.js 20, TypeScript)
- **Supabase** (PostgreSQL with Row-Level Security)
- **Firebase Authentication** (Identity provider)
- **OpenAI API** (GPT-4, zero-retention mode for HIPAA compliance)
- **Pinecone** (Vector database for RAG)

### Frontend
- **Next.js 14** (App Router, React 18, TypeScript 5)
- **Tailwind CSS** (Styling)
- **React Native** (Mobile app - future)

### Infrastructure
- **Terraform** (Infrastructure as Code)
- **GitHub Actions** (CI/CD)
- **GCP** (Cloud platform)

---

## Deployment Pipeline (CI/CD)

### GitHub Actions Workflow

The project uses GitHub Actions for automated deployment on push to `main` branch. The workflow (`.github/workflows/deploy.yml`) runs three jobs:

1. **Lint**: Validates code style across root and functions directories
2. **Test**: Runs backend tests (vitest) and E2E tests (Playwright)
3. **Deploy Functions**: Deploys all Google Cloud Functions to production

### Required GitHub Secrets

Configure these secrets in your GitHub repository settings:

- `GOOGLE_APPLICATION_CREDENTIALS`: Service account JSON key for GCP authentication
- `GCP_PROJECT_ID`: Your Google Cloud Project ID

### Deployment Process

1. Push to `main` branch triggers the workflow
2. Lint and test jobs run in parallel
3. If tests pass, GCF deployment begins
4. All functions are deployed to `us-central1` region
5. Functions are accessible via HTTP triggers

### Manual Deployment

To deploy functions manually:

```bash
cd functions
npm run build
gcloud functions deploy <function-name> \
  --gen2 \
  --runtime=nodejs20 \
  --region=us-central1 \
  --entry-point=<entry-point> \
  --trigger-http \
  --allow-unauthenticated \
  --source=. \
  --project=$GCP_PROJECT_ID
```

## Feature Flags

### Overview

The application uses **Firebase Remote Config** for feature flag management, enabling:
- Phased feature rollouts
- Emergency killswitches
- A/B testing capabilities
- Zero-downtime feature toggles

### Feature Flag Keys

All feature flags are defined in `client/src/services/featureFlags.ts`:

| Flag Key | Default | Purpose |
|----------|---------|---------|
| `enable_module_sleep` | `true` | Sleep Optimization module |
| `enable_module_morning` | `true` | Morning Routine module |
| `enable_module_focus` | `true` | Focus & Productivity module |
| `enable_module_stress` | `true` | Stress & Emotional Regulation module |
| `enable_module_energy` | `true` | Energy & Recovery module |
| `enable_module_dopamine` | `true` | Dopamine Hygiene module |
| `enable_ai_chat` | `true` | AI Coach chat killswitch |

### Setting Up Feature Flags in Firebase Console

1. Navigate to Firebase Console → Remote Config
2. Create a new parameter for each flag key listed above
3. Set default value to `true` (boolean)
4. Publish the configuration
5. Changes take effect within 12 hours (cache expiration) or immediately after app refresh

### Using Feature Flags in Code

```typescript
import { useFeatureFlags } from '../hooks/useFeatureFlags';

const MyComponent = () => {
  const { isModuleEnabled, isAiChatEnabled } = useFeatureFlags();
  
  if (!isModuleEnabled('sleep')) {
    return null; // Hide component
  }
  
  return <ModuleComponent />;
};
```

### Emergency Killswitch

To disable AI chat immediately:

1. Open Firebase Console → Remote Config
2. Find `enable_ai_chat` parameter
3. Set value to `false`
4. Publish configuration
5. AI chat button disappears from UI within cache expiration period (12 hours max)

### Testing Feature Flags

Feature flags can be tested locally by modifying `client/src/services/featureFlags.ts` default values, or by configuring Firebase Remote Config with test values.

## Configuration Files

### `AGENTS.md`
Instructs Codex on project conventions, coding standards, and testing strategy. **Critical:** This file tells Codex to write tests but NOT run them.

### `package.json`
- `test:ci` - Playwright tests (run by GitHub Actions)
- `test:backend` - Jest tests for backend
- No default `test` script to prevent Codex from auto-running tests

### `jest.config.js`
Configuration for backend unit testing with Jest.

### `playwright.config.ts`
Configuration for frontend E2E testing with Playwright.

---

## Contributing

### For AI Agents (Codex)
Read `AGENTS.md` for complete instructions. Your job is to:
1. Write clean, tested code
2. Create test files (don't run them)
3. Commit to a feature branch
4. Create a pull request

### For Human Developers
1. Review PRs created by Codex
2. Check that tests pass in GitHub Actions
3. Merge approved PRs
4. Provide feedback to Codex if changes are needed

---

## Security & Compliance

- **HIPAA Compliant:** All PHI/PII encrypted at rest and in transit
- **Zero-Retention:** OpenAI API configured with `zero_retention: true`
- **Firebase Auth:** JWT validation on all protected endpoints
- **Supabase RLS:** Row-Level Security enforced for all user data
- **Secrets Management:** All API keys in environment variables (never committed)

---

## Mission 001 Outcomes

This repository was initialized with MISSION_001, which established:
- Terraform templates to provision GCP project, Firebase services, and IAM roles
- Firebase Authentication as system IdP with tenant configuration
- Supabase schema + RLS policies wired to Firebase JWT claims
- Reference Google Cloud Function verifying Firebase JWTs and querying Supabase

Follow the documentation inside each directory to deploy infrastructure in your target environment.

---

## Support

For questions about the Codex workflow or mission specifications, refer to:
- `AGENTS.md` - Codex configuration and conventions
- `WellnessOS-Codex-Prompting-and-Agent-Config-Merged.md` - Detailed prompt guide
- `Master-Blueprint-Wellness-OS-V3.2-Gemini-Synthesis.md` - Complete mission specifications
