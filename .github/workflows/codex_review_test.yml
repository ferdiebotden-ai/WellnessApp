name: "CI: Code Review & Playwright Tests"

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  # Optional: Get AI feedback on code quality
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Allows Codex to comment on the PR
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: OpenAI Codex Review
        uses: openai/codex-action@v1 # This is the correct usage
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          # The action defaults to reviewing the code, no prompt needed here.

  # Required: Run Playwright tests to validate functionality
  playwright-tests:
    runs-on: ubuntu-latest
    needs: code-review # This job runs after the code review is complete
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright Tests
        run: npm test # This now correctly calls 'npx playwright test'
